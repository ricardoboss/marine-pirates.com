<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Marine-Pirates.com</title>
	<style>
		html, body, #content {
			border: none;
			padding: 0;
			margin: 0;
			width: 100%;
			height: 100%;
		}

		.invis { display: none; }

		#loader {
			width: 100%;
			font-size: 4rem;
			text-align: center;
			padding-top: 45vh;
		}
	</style>
</head>
<body>
	<div id="loader">Piratifying Marine-Pilots.com...</div>
	<iframe src="about:blank" class="invis" id="content"></iframe>
	<script>
		const targetUrl = "https://marine-pilots.com";
		const frame = document.getElementById('content');
		const loader = document.getElementById('loader');

		function piratify(html)
		{
			html = html
				.replaceAll(/Pilotage/g, 'Pirating')
				.replaceAll(/Pilots/g, 'Pirates')
				.replaceAll(/Pilot/g, 'Pirate')
				.replaceAll(/Privacy/g, 'Piracy')
				.replaceAll(/pilot/g, 'pirate')
				.replaceAll(/Vessel/g, 'Boatsy')
				.replaceAll(/vessel/g, 'boatsy')
				.replaceAll(/cookies/g, 'doubloons')
				.replaceAll(/colleagues/g, 'fellow wrongdoers')
				.replaceAll(/Capt\./g, 'Sail\'r')
				.replaceAll(/yesterday/g, 'yest\'rday')
				.replaceAll(/\bis\b/g, 'be')
				.replaceAll(/\bthe /g, 't\' ')
				.replaceAll(/\bThe /g, 'T\' ')
				//.replaceAll(/\bam\b/g, 'be')
				//.replaceAll(/(\w)v(\w)/g, '$1\'$2')
				.replaceAll(/ing\b/g, 'in\'')
				.replaceAll(/(\w)ar(\w)/g, '$1arrr$2')
				.replaceAll(/(\w)or(\w)/g, '$1orr$2')
				.replaceAll(/\bcr(\w)/g, 'crr$1')
				.replaceAll(/https:\/\/www.marrrine-pirates.com\//gi, 'https://www.marine-pilots.com/')
				.replaceAll(/https:\/\/marrrine-pirates.com\//gi, 'https://marine-pilots.com/')
				;

			//console.log(html);

			return html;
		}

		function qualifyRelativeLinks(html, domain)
		{
			//const resourcesDomain = "https://cors-anywhere.herokuapp.com/" + domain;

			html = html
				.replaceAll(/href="\//ig, `href="${domain}/`)
				.replaceAll(/<img(.+?)src="\//ig, `<img$1src="${domain}/`)
				.replaceAll(/<script(.+?)src="\//ig, `<script$1src="${domain}/`)
				//.replaceAll(/content="\//ig, `href="${resourcesDomain}/`)
				;

			//console.log(html);

			return html;
		}

		function handleResponse() {
			const html = this.responseText;
			const doc = (new DOMParser()).parseFromString(html, "text/html");
			const head = doc.head;
			const body = doc.body;

			frame.contentWindow.document.open();
			frame.contentWindow.document.clear();
			frame.contentWindow.document.write("<html><head>");
			frame.contentWindow.document.write(qualifyRelativeLinks(head.innerHTML, targetUrl));
			frame.contentWindow.document.write("</head><body>");
			frame.contentWindow.document.write(piratify(qualifyRelativeLinks(body.innerHTML, targetUrl)));
			frame.contentWindow.document.write("</body></html>");
			frame.contentWindow.document.close();

			loader.className = "invis";
			frame.className = "";
		}

		(function () {
			const cors_api_host = 'cors-anywhere.herokuapp.com';
			const cors_api_url = 'https://' + cors_api_host + '/';
			let slice = [].slice;
			let origin = window.location.protocol + '//' + window.location.host;
			let open = XMLHttpRequest.prototype.open;
			XMLHttpRequest.prototype.open = function () {
				let args = slice.call(arguments);
				let targetOrigin = /^https?:\/\/([^\/]+)/i.exec(args[1]);
				if (targetOrigin && targetOrigin[0].toLowerCase() !== origin &&
					targetOrigin[1] !== cors_api_host) {
					args[1] = cors_api_url + args[1];
				}
				return open.apply(this, args);
			};
		})();

		(async function () {
			"use strict";

			let xml = new XMLHttpRequest();
			xml.addEventListener("load", handleResponse);
			xml.open("GET", targetUrl);
			xml.send();
		})();
	</script>
</body>
</html>
